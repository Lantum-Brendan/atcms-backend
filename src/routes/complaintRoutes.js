// Generated by Copilot
const express = require('express');
const router = express.Router();
const complaintController = require('../controllers/complaintController');
const { protect, restrictTo } = require('../middleware/authMiddleware');
const { uploadFiles } = require('../middleware/uploadMiddleware');
const { validateComplaint } = require('../middleware/validationMiddleware');
const catchAsync = require('../utils/catchAsync');

// Protect all routes
router.use(protect);

// Analytics routes
router.get('/analytics',
    restrictTo('hod', 'coordinator', 'admin'),
    catchAsync(complaintController.getAnalytics)
);

// Admin specific routes
router.get('/admin',
    restrictTo('admin'),
    catchAsync(complaintController.getAdminComplaints)
);

// Routes accessible by all authenticated users
router.get('/', catchAsync(complaintController.getAllComplaints));
router.get('/:id', catchAsync(complaintController.getComplaintById));

// Student routes
router.post('/',
    restrictTo('student'),
    uploadFiles,
    validateComplaint,
    catchAsync(complaintController.createComplaint)
);

// HOD and Coordinator routes
router.patch('/:id/status',
    restrictTo('hod', 'coordinator', 'admin'),
    uploadFiles,
    catchAsync(complaintController.updateStatus)
);

router.post('/:id/comments',
    restrictTo('hod', 'coordinator', 'admin'),
    catchAsync(complaintController.addComment)
);

router.post('/:id/files',
    restrictTo('hod', 'coordinator', 'admin'),
    uploadFiles,
    catchAsync(complaintController.uploadFiles)
);

router.post('/:id/escalate',
    restrictTo('hod', 'coordinator'),
    uploadFiles,
    catchAsync(complaintController.escalateComplaint)
);

router.post('/bulk-resolve',
    restrictTo('hod', 'coordinator', 'admin'),
    catchAsync(complaintController.bulkResolveComplaints)
);

// Notification routes
router.get('/:id/notifications',
    catchAsync(complaintController.getNotifications)
);

router.patch('/:id/notifications/:notificationId',
    catchAsync(complaintController.markNotificationRead)
);

// Admin only routes
router.post('/admin-actions',
    restrictTo('admin'),
    catchAsync(complaintController.systemAdminActions)
);

// Add instruction to complaint
router.post('/:id/instruction',
    restrictTo('hod', 'coordinator'),
    uploadFiles,
    catchAsync(complaintController.addInstruction)
);

// Resolve complaint
router.post('/:id/resolve',
    restrictTo('admin'),
    uploadFiles,
    catchAsync(complaintController.resolveComplaint)
);

module.exports = router;