# Authentication System Documentation for Backend Implementation
Generated by Copilot

## Database Schema

### User Model
```typescript
interface User {
    id: string;
    name: string;
    email: string;
    matricule: string;  // Added for matricule-based login
    role: Role;
    faculty?: string;
    program?: string;
    status: 'Active' | 'Inactive';
    createdDate: string;
    password: string; // Store hashed, never return in responses
}
```

### Roles
```typescript
const roles = {
    STUDENT: 'student',
    HOD: 'hod',
    COORDINATOR: 'coordinator',
    ADMIN: 'admin',
} as const;

type Role = typeof roles[keyof typeof roles];
```

## Authentication Endpoints

### 1. Login Endpoint
- **Route**: POST /api/auth/login
- **Request Body**:
```typescript
interface LoginCredentials {
    identifier: string;    // Can be either email or matricule
    password: string;
}
```
- **Response**:
```typescript
interface LoginResponse {
    id: string;
    name: string;
    email: string;
    matricule: string;
    role: Role;
    program?: string;
    status: 'Active' | 'Inactive';
    createdDate: string;
    token: string;    // JWT token
}
```
- **Error Responses**:
    - 401: Invalid credentials
    - 403: Account inactive
    - 500: Server error

### 2. Student Registration Endpoint
- **Route**: POST /api/auth/register
- **Access**: Public
- **Description**: Self-registration endpoint for students only
- **Request Body**:
```typescript
interface StudentRegistration {
    name: string;
    matricule: string;
    email: string;
    faculty: string;
    program: string;
    phone?: string;
    password: string;
}
```
- **Response**: Same as LoginResponse
- **Notes**:
    - Automatically assigns STUDENT role
    - Sets status to 'Active'
    - Requires email verification
    - Validates unique matricule and email

### 3. Admin User Management Endpoint
- **Route**: POST /api/admin/users
- **Access**: ADMIN role only
- **Description**: Endpoint for admin to create any type of user
- **Request Body**:
```typescript
interface AdminUserCreation {
    name: string;
    email: string;
    matricule: string;
    role: Role;
    faculty?: string;
    program?: string;
    phone?: string;
    password: string;
    status?: 'Active' | 'Inactive';
}
```
- **Response**: User object without password
- **Notes**:
    - Requires admin authentication
    - Can create users with any role
    - Faculty/Program required for STUDENT, HOD, COORDINATOR roles
    - Validates unique matricule and email
    - Auto-generates createdDate

### 4. Logout Endpoint
- **Route**: POST /api/auth/logout
- **Headers**: Authorization: Bearer {token}
- **Response**: 200 OK

### 5. Get Current User
- **Route**: GET /api/auth/me
- **Headers**: Authorization: Bearer {token}
- **Response**: Same as LoginResponse (without token)

## Role-Based Access Control

### Route Access Rules
```typescript
const routeAccess = {
    '/dashboard/student': [roles.STUDENT],
    '/dashboard/hod': [roles.HOD],
    '/dashboard/coordinator': [roles.COORDINATOR],
    '/dashboard/admin': [roles.ADMIN],
}
```

### Program/Faculty Access Rules
- Students: Can only access their own program
- HODs: Can access all programs in their faculty
- Coordinators: Can access assigned programs
- Admins: Can access all programs and faculties

## User Management Features

### Create User
- Only accessible by ADMIN role
- Requires all User fields except id
- Auto-generates createdDate
- Requires password validation (min length, complexity)
- Validates unique email
- Faculty/Program required for STUDENT, HOD, COORDINATOR roles

### Update User
- ADMIN can update any user
- Users can update their own profiles (limited fields)
- Cannot change own role
- Email changes require verification
- Status changes logged

### Delete User
- Soft delete (status = 'Inactive')
- Only ADMIN can perform
- Cannot delete last ADMIN user
- Archives associated data

## Security Requirements

1. **Password Storage**:
     - Use bcrypt for password hashing
     - Minimum 10 rounds of salt

2. **JWT Implementation**:
     - Include user ID, matricule, and role in payload
     - 24-hour expiration
     - Refresh token mechanism
     - Secure httpOnly cookies

3. **Login Attempt Handling**:
     - Track attempts by both email and matricule
     - Max 5 failed login attempts per identifier
     - 15-minute lockout period
     - IP-based rate limiting

4. **Input Validation**:
     - Email format validation
     - Matricule format validation (e.g., STU12345)
     - Password minimum requirements
     - Sanitize all inputs
     - Validate role assignments

## Mock Data (Development Only)
```typescript
const mockUsers = [
    {
        id: '1',
        name: 'John Doe',
        email: 'student@example.com',
        password: 'password123',
        role: roles.STUDENT,
        faculty: 'Science',
        program: 'Computer Science',
        status: 'Active',
        createdDate: '2025-01-01'
    },
    {
        id: '2',
        name: 'Jane Smith',
        email: 'hod@example.com',
        password: 'password123',
        role: roles.HOD,
        faculty: 'Science',
        program: 'Mathematics',
        status: 'Active',
        createdDate: '2025-01-02'
    },
    {
        id: '3',
        name: 'Alice Johnson',
        email: 'coordinator@example.com',
        password: 'password123',
        role: roles.COORDINATOR,
        faculty: 'Engineering',
        program: 'Mechanical Engineering',
        status: 'Active',
        createdDate: '2025-01-03'
    },
    {
        id: '4',
        name: 'Admin User',
        email: 'admin@example.com',
        password: 'password123',
        role: roles.ADMIN,
        status: 'Active',
        createdDate: '2025-01-04'
    }
];
```

## Authentication Flow

1. User provides email/matricule and password
2. Backend validates credentials against both fields
3. If valid:
     - Generate JWT token
     - Return user data and token
     - Store session
4. Frontend:
     - Stores token securely
     - Redirects based on role
     - Includes token in subsequent requests

## Error Handling

Implement consistent error responses:
```typescript
interface ErrorResponse {
    error: string;
    message: string;
    code: number;
    details?: any;
}
```

Common error scenarios:
- Invalid credentials
- Expired token
- Insufficient permissions
- Rate limit exceeded
- Invalid input data
- Server errors

## Middleware Requirements

1. **Authentication Middleware**:
     - Validate JWT tokens
     - Attach user to request
     - Handle expired tokens

2. **Role Middleware**:
     - Validate user roles
     - Check route permissions
     - Handle unauthorized access

3. **Validation Middleware**:
     - Validate request bodies
     - Sanitize inputs
     - Type checking

4. **Error Handling Middleware**:
     - Catch all errors
     - Format error responses
     - Log errors appropriately